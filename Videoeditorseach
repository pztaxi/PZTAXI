import logging
import sqlite3
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils import executor

# Ğ¢Ğ²Ñ–Ğ¹ API Ñ‚Ğ¾ĞºĞµĞ½
API_TOKEN = "7387148983:AAF5yYzKRM4diecHgoO9ODI3jVl-WTtRqyk"

# Ğ†Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ Ğ±Ğ¾Ñ‚Ğ°
bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)

# Ğ›Ğ¾Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
logging.basicConfig(level=logging.INFO)

# ĞŸÑ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ½Ñ Ğ´Ğ¾ Ğ±Ğ°Ğ·Ğ¸ Ğ´Ğ°Ğ½Ğ¸Ñ… (Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ¸Ğ±Ñ–Ñ€ Ğ¼Ğ¾Ğ²Ğ¸)
conn = sqlite3.connect("users.db")
cursor = conn.cursor()
cursor.execute("CREATE TABLE IF NOT EXISTS users (user_id INTEGER PRIMARY KEY, language TEXT)")
conn.commit()

# ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Ğ¼Ğ¾Ğ²Ğ¸
lang_keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
lang_keyboard.add(KeyboardButton("ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°"), KeyboardButton("ğŸ‡¬ğŸ‡§ English"))
lang_keyboard.add(KeyboardButton("ğŸ‡µğŸ‡± Polski"), KeyboardButton("ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹"))

# Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ Ğ¼Ğ¾Ğ²Ğ¸
def set_language(user_id, language):
    cursor.execute("INSERT OR REPLACE INTO users (user_id, language) VALUES (?, ?)", (user_id, language))
    conn.commit()

# ĞÑ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ½Ñ Ğ¼Ğ¾Ğ²Ğ¸ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ°
def get_language(user_id):
    cursor.execute("SELECT language FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    return result[0] if result else "ğŸ‡¬ğŸ‡§ English"

# ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° ÑÑ‚Ğ°Ñ€Ñ‚Ñƒ
@dp.message_handler(commands=["start"])
async def send_welcome(message: types.Message):
    await message.answer("ğŸŒ Ğ’Ğ¸Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ¼Ğ¾Ğ²Ñƒ / Choose your language:", reply_markup=lang_keyboard)

# ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Ğ¼Ğ¾Ğ²Ğ¸
@dp.message_handler(lambda message: message.text in ["ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°", "ğŸ‡¬ğŸ‡§ English", "ğŸ‡µğŸ‡± Polski", "ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹"])
async def set_user_language(message: types.Message):
    set_language(message.from_user.id, message.text)
    texts = {
        "ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°": "Ğ’Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ»Ğ¸ ÑƒĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºÑƒ ğŸ‡ºğŸ‡¦\nĞĞ°Ğ´Ñ–ÑˆĞ»Ñ–Ñ‚ÑŒ Ğ¾Ğ¿Ğ¸Ñ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ:",
        "ğŸ‡¬ğŸ‡§ English": "You have selected English ğŸ‡¬ğŸ‡§\nSend your order description:",
        "ğŸ‡µğŸ‡± Polski": "WybraÅ‚eÅ› jÄ™zyk polski ğŸ‡µğŸ‡±\nPrzeÅ›lij opis zamÃ³wienia:",
        "ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹": "Ğ’Ñ‹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸ Ñ€ÑƒÑÑĞºĞ¸Ğ¹ ğŸ‡·ğŸ‡º\nĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ğ°:"
    }
    await message.answer(texts[message.text])

# ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½ÑŒ
@dp.message_handler()
async def handle_order(message: types.Message):
    user_lang = get_language(message.from_user.id)
    
    # ĞšĞ°Ğ½Ğ°Ğ» Ğ´Ğ»Ñ Ğ¿ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ†Ñ–Ñ— (Ğ·Ğ°Ğ¼Ñ–Ğ½Ñ–Ñ‚ÑŒ Ğ½Ğ° Ğ²Ğ°Ñˆ)
    CHANNEL_ID = "@your_channel"

    texts = {
        "ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°": "âœ… ĞĞ¾Ğ²Ğµ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ!\n\nğŸ“„ ĞĞ¿Ğ¸Ñ: {}\nğŸ“© ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚: @{}",
        "ğŸ‡¬ğŸ‡§ English": "âœ… New Order!\n\nğŸ“„ Description: {}\nğŸ“© Contact: @{}",
        "ğŸ‡µğŸ‡± Polski": "âœ… Nowe zamÃ³wienie!\n\nğŸ“„ Opis: {}\nğŸ“© Kontakt: @{}",
    }

    # Ğ¤Ğ¾Ñ€Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ Ğ´Ğ»Ñ Ğ¿ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ†Ñ–Ñ—
    order_text = texts[user_lang].format(message.text, message.from_user.username)
    
    # Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ² ĞºĞ°Ğ½Ğ°Ğ»
    await bot.send_message(CHANNEL_ID, order_text)
    await message.answer("âœ… Ğ’Ğ°ÑˆĞµ Ğ·Ğ°Ğ¼Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ğ¿ÑƒĞ±Ğ»Ñ–ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾!")

# Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
